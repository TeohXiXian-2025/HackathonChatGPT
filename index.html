<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeRoute: Family-First Disaster Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        
        .tab-button { 
            padding: 0.75rem 0.5rem; 
            text-align: center; 
            color: #4b5563; 
            font-weight: 600; 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s;
            touch-action: manipulation; 
        }
        .tab-button.active { 
            border-color: #4f46e5; 
            color: #4f46e5; 
            background: #eef2ff; 
        }
        .card { 
            background: white;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0;
        }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }

        .chat-window .user-message { 
            background-color: #3b82f6; 
            color: white; 
            padding: 0.75rem; 
            border-radius: 0.75rem 0.75rem 0 0.75rem; 
            align-self: flex-end; 
            max-width: 85%; 
            margin-left: auto;
            word-wrap: break-word;
        }
        .chat-window .ai-message { 
            background-color: #ffffff; 
            color: #1f2937; 
            padding: 0.75rem; 
            border-radius: 0.75rem 0.75rem 0.75rem 0; 
            border: 1px solid #e5e7eb; 
            align-self: flex-start; 
            max-width: 85%; 
            margin-right: auto;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <header class="bg-indigo-700 text-white p-4 shadow-xl">
        <h1 class="text-2xl font-extrabold tracking-tight">SafeRoute: Disaster Hub</h1>
        <p id="user-id-display" class="text-xs opacity-70 mt-1">Guest ID: <span id="uid-span"></span></p>
    </header>

    <div id="guest-info" class="p-3 bg-yellow-50 border-b border-yellow-400">
        <div class="max-w-4xl mx-auto text-sm text-yellow-800 font-medium text-center md:text-left">
            ‚ö†Ô∏è Logic Update: Distance is now calculated mathematically before AI analysis.
        </div>
    </div>
    
    <nav class="bg-white shadow-lg sticky top-0 z-10">
        <div class="grid grid-cols-3 md:grid-cols-3 border-b border-gray-200">
            <button class="tab-button active" onclick="showTab('situation')" id="tab-situation">1. Situation</button>
            <button class="tab-button" onclick="showTab('routing')" id="tab-routing">2. Intelligent Route</button>
            <button class="tab-button" onclick="showTab('qr-passport')" id="tab-qr-passport">3. QR Passport</button>
        </div>
    </nav>

    <main class="flex-1 p-4 overflow-y-auto max-w-4xl mx-auto">

        <section id="situation" class="tab-content space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">1. Situation & Needs Assessment</h2>
            
            <p class="text-base text-gray-600 font-semibold bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                Phase 1: Confirm your location and clearly describe your family's needs for safe routing.
            </p>
            
            <div class="card p-5">
                <h3 class="text-xl font-extrabold text-indigo-700 mb-3 flex items-center gap-2">üìç Confirm Location</h3>
                
                <div id="location-status-container">
                    <p id="current-location-display" class="text-base text-gray-700 font-semibold pulse-animation mb-4">Initializing...</p>
                    
                    <div id="manual-location-form" class="mt-4 border-t pt-4 hidden space-y-3">
                        <p id="manual-form-message" class="text-sm font-bold text-gray-700">Is this wrong? Enter your location manually:</p>
                        <input type="text" id="manual-city-input" placeholder="Enter City/Suburb (e.g., Pasir Gudang)" class="w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                        <button type="button" onclick="handleManualLocationUpdate()" class="w-full py-3 px-4 rounded-lg text-white font-bold bg-gray-600 hover:bg-gray-700 transition">Update Location Manually</button>
                    </div>
                </div>
            </div>

            <div class="card p-5">
                <h3 class="text-xl font-extrabold text-gray-800 mb-3">Describe Needs (Semantic Input)</h3>
                <p class="text-sm text-gray-600 mb-4">Input your family's situation to decode specific needs (vulnerabilities).</p>
                <p class="text-xs text-indigo-500 italic mb-3 p-2 bg-indigo-50 rounded-lg">Example: <strong>"4 people, one is elderly who can't walk, and we have a pet cat."</strong></p>

                <form id="semantic-form" class="space-y-4">
                    <textarea id="semantic-input" required rows="3" placeholder="Describe your family's situation and vulnerabilities here..." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-indigo-500 focus:border-indigo-500"></textarea>

                    <button type="submit" id="semantic-submit-button" class="w-full py-3 px-4 rounded-lg shadow-lg text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition">
                        ‚ú® Get Safe Route & Local Status
                    </button>
                </form>
            </div>
        </section>

        <section id="routing" class="tab-content hidden space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">2. Intelligent Routing Analysis</h2>
            
            <div id="local-status-results-routing" class="card p-5 border-l-4 transition duration-300">
                <h3 class="text-xl font-extrabold text-red-700 mb-3 flex items-center">üö® PPS Selection Analysis</h3>
                <div id="status-content">
                    <p class="text-sm text-gray-500">Awaiting status check from JamAI Base...</p>
                </div>
            </div>

            <div class="card p-5">
                <p class="text-lg font-extrabold text-indigo-700 mb-2">AI Decoded Needs:</p>
                <div id="current-vulnerabilities" class="text-gray-500 italic text-base mb-4">
                    Awaiting JamAI decoding...
                </div>
                <p class="text-xs text-gray-500">Calculation based on: 
                    <span id="routing-coords" class="font-mono text-gray-700">N/A</span>
                </p>
                <div id="distance-debug-log" class="mt-2 text-xs text-gray-500 font-mono bg-gray-100 p-2 rounded hidden"></div>
            </div>

            <div id="routing-results" class="space-y-4">
                <div id="analysis-display" class="card p-5 bg-white border-2 border-indigo-400 hidden"></div>
                <div id="best-match-display" class="card p-5 text-center hidden bg-green-50 border-2 border-green-400"></div>

                <div class="flex justify-end">
                    <span id="save-routing-status" class="ml-3 text-xs text-gray-600"></span>
                </div>

                <p id="jamai-citation" class="text-xs text-gray-500 pt-4 border-t hidden">
                    AI Reasoning provided by JamAI Base (with PPS Knowledge RAG).
                </p>
            </div>
        </section>

        <section id="qr-passport" class="tab-content hidden space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">3. JKM Passport Creation</h2>
            <p class="text-base text-gray-600">Complete the details below to generate your Zero-Typing QR Passport for rapid registration.</p>

            <div id="save-status" class="p-3 text-sm rounded-lg font-medium hidden"></div>

            <form id="family-form" class="space-y-4 card p-5">
                <label class="block text-sm font-semibold text-gray-700">Head of Family Name</label>
                <input type="text" id="headName" required class="mt-1 block w-full rounded-lg p-3 border">
                
                <label class="block text-sm font-semibold text-gray-700">IC Number (12 digits)</label>
                <input type="text" id="icNumber" required pattern="\d{12}" title="12 digits without dashes" class="mt-1 block w-full rounded-lg p-3 border">
                
                <label class="block text-sm font-semibold text-gray-700">Home Address</label>
                <textarea id="address" required rows="2" class="mt-1 block w-full rounded-lg p-3 border"></textarea>
                
                <label class="block text-sm font-semibold text-gray-700">Total Family Size</label>
                <input type="number" id="familySize" required min="1" value="1" class="mt-1 block w-full rounded-lg p-3 border">
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm font-bold text-gray-800 mb-1">Stored Needs:</p>
                    <div id="vulnerability-list-display" class="text-sm text-gray-700">None saved.</div>
                </div>

                <button type="submit" class="w-full py-3 px-4 rounded-lg shadow-md text-base font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition">
                    Save Details & Generate QR Passport
                </button>
            </form>

            <div id="qr-container" class="flex flex-col items-center justify-center card p-6 space-y-4">
                <div id="qrcode-display" class="p-4 border-4 border-indigo-600 rounded-xl bg-white shadow-2xl">
                    <canvas id="qr-canvas" class="w-64 h-64 md:w-80 md:h-80"></canvas>
                </div>
                <p id="qr-status" class="text-center text-red-500 font-bold">No family data saved yet.</p>
                <div class="flex flex-col gap-2 w-full max-w-sm">
                    <button id="download-qr-button" class="w-full py-3 px-4 rounded-lg text-sm font-bold bg-green-600 text-white hover:bg-green-700 transition shadow-lg hidden" onclick="downloadQR()">
                        üì• Download QR to Gallery
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURATION ---
        const IP2LOCATION_KEY = "D2D17B84A589ED1060A87E4DD69AC1A9"; 
        
        let userLocation = { 
            city: null, region: null, lat: null, lon: null, source: null 
        };
        
        window.isGuest = true;
        const GUEST_ID_KEY = 'smartpps_guest_id';
        if (!localStorage.getItem(GUEST_ID_KEY)) localStorage.setItem(GUEST_ID_KEY, 'guest-' + crypto.randomUUID());
        window.userId = localStorage.getItem(GUEST_ID_KEY);
        document.getElementById('uid-span').textContent = window.userId.substring(0, 8);

        // --- MATH & DISTANCE UTILS (The Fix for Hallucinations) ---

        // 1. Haversine Formula: Calculates accurate distance between two coords
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return parseFloat((R * c).toFixed(2)); // Return distance in KM, 2 decimals
        }

        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // 2. Geocoding: Converts "Pasir Gudang" -> {lat: 1.46, lon: 103.90}
        async function getCoordsFromInput(cityInput) {
            // Case A: No manual input, use existing GPS/IP if available
            if (!cityInput && userLocation.lat && userLocation.lon) {
                return { lat: userLocation.lat, lon: userLocation.lon, name: "Detected Location" };
            }
            
            // Case B: User typed a city. We must fetch coords.
            const query = cityInput || userLocation.city;
            if (!query) return null;

            console.log(`Geocoding search for: ${query}`);
            try {
                // Using OpenStreetMap Nominatim (Free, rate-limited)
                const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=my&q=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data && data.length > 0) {
                    return { 
                        lat: parseFloat(data[0].lat), 
                        lon: parseFloat(data[0].lon),
                        name: data[0].display_name 
                    };
                }
            } catch (e) {
                console.error("Geocoding failed", e);
            }
            return null;
        }

        // --- LOCATION UI LOGIC ---
        function updateLocationUI() {
            const display = document.getElementById('current-location-display');
            const manualForm = document.getElementById('manual-location-form');
            const manualMessage = document.getElementById('manual-form-message');
            const routingCoords = document.getElementById('routing-coords');
            
            display.classList.remove('pulse-animation');
            let coordsDisplay = "No Coords";

            if (userLocation.lat && userLocation.lon) {
                coordsDisplay = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
            }

            if (userLocation.source === 'GPS') {
                display.innerHTML = `‚úÖ <b>GPS Confirmed:</b> ${userLocation.city || 'Current Location'} <span class="text-xs text-gray-500">(${coordsDisplay})</span>`;
                manualForm.classList.add('hidden');
            } else if (userLocation.source === 'IP') {
                display.innerHTML = `‚ö†Ô∏è <b>Network Detected:</b> We think you are in <b class="text-indigo-700">${userLocation.city || 'Malaysia'}</b>.`;
                manualForm.classList.remove('hidden');
                manualMessage.className = "text-sm font-semibold text-gray-700";
                manualMessage.innerHTML = `üìç <b>Is this wrong?</b> Enter your actual City/Suburb below:`;
            } else if (userLocation.source === 'Manual') {
                display.innerHTML = `üìç <b>Manual Location:</b> ${userLocation.city}`;
                manualForm.classList.remove('hidden'); // Keep it visible to allow changes
                manualMessage.innerHTML = "Location set manually.";
            } else {
                display.innerHTML = `‚ùå <b>Location Unknown.</b>`;
                display.classList.add('pulse-animation');
                manualForm.classList.remove('hidden');
                manualMessage.className = "text-sm font-bold text-red-600";
                manualMessage.innerHTML = "‚ùå Auto-detection failed. Please enter your location:";
            }
            routingCoords.textContent = `${coordsDisplay} (Source: ${userLocation.source || 'None'})`;
        }

        function handleManualLocationUpdate() {
            const cityInput = document.getElementById('manual-city-input').value.trim();
            if (cityInput) {
                userLocation.city = cityInput;
                userLocation.source = 'Manual';
                // Reset coords so geocoding triggers during submission
                userLocation.lat = null; 
                userLocation.lon = null; 
                updateLocationUI();
                alert(`Location set to ${cityInput}. Coordinates will be calculated upon submission.`);
            }
        }

        // --- LOCATION DETECTION (GPS -> IP) ---
        function savePosition(position) {
            userLocation.lat = position.coords.latitude;
            userLocation.lon = position.coords.longitude;
            userLocation.city = 'Current Location'; 
            userLocation.source = 'GPS';
        }
        
        async function getIPLocation() {
            try {
                const response = await fetch(`https://api.ip2location.io/?key=${IP2LOCATION_KEY}&format=json`);
                if (!response.ok) throw new Error('IP API Error');
                const data = await response.json();
                if (data && data.city_name) {
                    userLocation.lat = parseFloat(data.latitude);
                    userLocation.lon = parseFloat(data.longitude);
                    userLocation.city = data.city_name; 
                    userLocation.source = 'IP';
                    return true;
                }
            } catch (e) { console.warn("IP Location failed.", e); }
            return false;
        }

        const getPos = (opts) => new Promise((res, rej) => {
            if (!navigator.geolocation) return rej(new Error("Geolocation not supported."));
            navigator.geolocation.getCurrentPosition(res, rej, opts);
        });
        
        async function getUserLocation() {
            const display = document.getElementById('current-location-display');
            display.classList.add('pulse-animation');
            display.innerHTML = 'Detecting location...';

            try {
                const position = await getPos({ enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
                savePosition(position);
                updateLocationUI();
                return; 
            } catch (e) { console.log("GPS failed. Trying IP."); }

            if (await getIPLocation()) { updateLocationUI(); return; }

            userLocation.source = null;
            updateLocationUI();
        }

        // --- SUBMISSION LOGIC (THE HYBRID MATH + AI PART) ---
        document.getElementById("semantic-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const inputText = document.getElementById("semantic-input").value;
            const button = document.getElementById('semantic-submit-button');
            const routingStatus = document.getElementById('save-routing-status');
            const debugLog = document.getElementById('distance-debug-log');
            
            button.disabled = true; 
            button.classList.add('opacity-50'); 
            button.textContent = 'üìê Calculating Distances...';
            
            // 1. Resolve Location (Geocode Manual Input if necessary)
            const manualInput = document.getElementById('manual-city-input').value;
            let userCoords = await getCoordsFromInput(manualInput);

            if (!userCoords || isNaN(userCoords.lat)) {
                alert("Could not find coordinates for your location. Please check the spelling of your city.");
                button.disabled = false; button.classList.remove('opacity-50'); button.textContent = '‚ú® Get Safe Route';
                return;
            }

            // Update UI with resolved coords
            document.getElementById('routing-coords').textContent = `${userCoords.lat.toFixed(4)}, ${userCoords.lon.toFixed(4)}`;

            // 2. Load & Filter Shelter Data
            let nearbyShelters = [];
            try {
                // Fetch the JSON file (Must be hosted locally or on server)
                const res = await fetch('flood_shelters_H.json');
                const shelters = await res.json();
                
                // MATH: Calculate distance for every shelter
                const sheltersWithDist = shelters.map(s => {
                    return {
                        ...s,
                        real_dist: calculateDistance(userCoords.lat, userCoords.lon, s.latitude, s.longitude)
                    };
                });

                // Sort: Closest first
                sheltersWithDist.sort((a, b) => a.real_dist - b.real_dist);
                
                // Filter: Top 3
                nearbyShelters = sheltersWithDist.slice(0, 3);

                // Debug Display
                debugLog.classList.remove('hidden');
                debugLog.innerHTML = `<b>Math Verified Closest:</b><br>` + 
                    nearbyShelters.map(s => `${s.shelter_name}: ${s.real_dist} km`).join('<br>');

            } catch (err) {
                console.error("Failed to load/process shelter JSON", err);
                alert("Error loading shelter database. Ensure 'flood_shelters_H.json' is in the same folder.");
                button.disabled = false; button.textContent = 'Try Again';
                return;
            }

            // 3. Prepare AI Prompt (Injecting Math Facts)
            // We give the AI the specific distances so it cannot hallucinate.
            const ppsContext = nearbyShelters.map(s => 
                `- ${s.shelter_name} (ID: ${s.id}): EXACT DISTANCE ${s.real_dist} KM away. Facilities: ${s.benefits.join(', ')}. Tags: ${s.friendly_tags.join(', ')}.`
            ).join("\n");

            const finalContextData = `User Location: ${userCoords.name} (${userCoords.lat}, ${userCoords.lon}).\n\nVerified Closest Shelters (Math-Calculated):\n${ppsContext}\n\nUser Needs: ${inputText}`;

            // 4. Send to API
            button.textContent = '‚ú® AI Analyzing Needs...';
            document.getElementById("analysis-display").classList.remove("hidden");
            document.getElementById("best-match-display").classList.remove("hidden");
            showTab("routing");

            const payload = { 
                user_input: inputText, 
                location_details: userCoords.name,
                // THIS IS THE KEY: We send the filtered list + calculated distances as context
                context_data: finalContextData 
            };

            try {
                const apiRes = await fetch("/api/analyze", {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
                });
                
                const data = await apiRes.json();
                
                if (apiRes.ok && data.status === 'submitted') {
                    routingStatus.textContent = `Job submitted. Polling ID: ${data.row_id}`;
                    pollForResults(data.row_id, button, routingStatus);
                } else {
                     routingStatus.textContent = "‚ùå Submission failed.";
                     button.disabled = false; button.classList.remove('opacity-50');
                }
            } catch (error) {
                console.error(error);
                routingStatus.textContent = "‚ùå Network error.";
                button.disabled = false;
            }
        });

        // --- POLLING LOGIC ---
        async function pollForResults(rowId, button, routingStatus) {
            const statusCard = document.getElementById('local-status-results-routing');
            const interval = setInterval(async () => {
                try {
                    const res = await fetch("/api/analyze", {
                        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ row_id: rowId })
                    });
                    const data = await res.json();

                    if (data.status === 'complete' && data.success) {
                        clearInterval(interval);
                        
                        // Parse tags
                        const tagsString = typeof data.tags === 'string' ? data.tags : '';
                        const decodedTags = tagsString.split(',').map(t => t.trim()).filter(Boolean);
                        
                        // Update UI
                        document.getElementById("current-vulnerabilities").innerHTML = `<span class="font-bold text-indigo-700">${(decodedTags.length > 0 ? decodedTags : ['N/A']).join('; ')}</span>`;
                        document.getElementById("analysis-display").textContent = data.analysis;
                        document.getElementById("best-match-display").innerHTML = `
                            <p class="text-2xl font-extrabold text-green-700">Best Match Found!</p>
                            <p class="text-4xl font-extrabold text-indigo-700 my-2">${data.selected_pps || 'See Analysis'}</p>
                            <p class="text-lg text-gray-700">Proceed to the QR Passport tab.</p>
                        `;
                        document.getElementById("jamai-citation").classList.remove("hidden");
                        
                        statusCard.className = "card p-5 border-l-4 transition duration-300 bg-green-100 border-green-500";
                        document.getElementById('status-content').innerHTML = `<p class="text-sm font-bold text-green-800">‚úÖ Routing successful.</p>`;
                        
                        // Save for passport
                        window.saveFamilyData({ vulnerabilities: decodedTags });
                        
                        button.disabled = false; 
                        button.classList.remove('opacity-50');
                        button.textContent = '‚ú® Analysis Complete';
                        
                    } else if (data.status === 'pending') {
                        routingStatus.textContent = `Processing...`;
                    } else {
                        clearInterval(interval);
                        routingStatus.textContent = `‚ùå Error: ${data.error}`;
                        button.disabled = false;
                    }
                } catch (error) { clearInterval(interval); }
            }, 3000);
        }

        // --- PASSPORT & STORAGE UTILS ---
        window.saveFamilyData = async (data) => {
            const key = `smartpps_profile_${window.userId}`;
            const existing = JSON.parse(localStorage.getItem(key) || '{}');
            const merged = Object.assign({}, existing, data);
            localStorage.setItem(key, JSON.stringify(merged));
            window.familyData = merged;
            updateUIAfterDataLoad(merged);
            return true;
        };

        window.loadFamilyData = async () => {
            const key = `smartpps_profile_${window.userId}`;
            const stored = localStorage.getItem(key);
            window.familyData = stored ? JSON.parse(stored) : {};
            updateUIAfterDataLoad(window.familyData);
        };

        function updateUIAfterDataLoad(data) {
            const form = document.getElementById('family-form');
            if (Object.keys(data).length > 0) {
                ['headName', 'icNumber', 'address', 'familySize'].forEach(k => {
                    if (form[k] && data[k]) form[k].value = data[k];
                });
                document.getElementById('vulnerability-list-display').textContent = data.vulnerabilities?.join('; ') || 'None saved.';
            }
            updateQRCode(data);
            const dlBtn = document.getElementById('download-qr-button');
            if(data.jkmPayload) dlBtn.classList.remove('hidden');
        }

        function generateJKMQRPayload(data) {
            return JSON.stringify({
                schema: "JKM_PPS_v1.0", 
                ref_id: window.userId.substring(0,8),
                nama: data.headName, 
                ic: data.icNumber, 
                needs: data.vulnerabilities 
            });
        }

        function updateQRCode(data = window.familyData) {
            const canvas = document.getElementById('qr-canvas');
            if (data && data.jkmPayload) {
                QRCode.toCanvas(canvas, data.jkmPayload, { width: 300 }, (e) => { if(e) console.error(e); });
                document.getElementById('qr-status').textContent = "Ready to Scan";
                document.getElementById('qr-status').className = "text-center text-green-600 font-bold";
            }
        }
        
        function downloadQR() {
            const link = document.createElement('a');
            link.download = 'SafeRoute_ID.png';
            link.href = document.getElementById('qr-canvas').toDataURL();
            link.click();
        }

        document.getElementById('family-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                headName: form.headName.value, icNumber: form.icNumber.value, 
                address: form.address.value, familySize: form.familySize.value,
                vulnerabilities: window.familyData.vulnerabilities || []
            };
            data.jkmPayload = generateJKMQRPayload(data);
            await window.saveFamilyData(data);
            document.getElementById('save-status').textContent = "Saved!";
            document.getElementById('save-status').classList.remove('hidden');
        });

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
            if (tabId === 'qr-passport') updateQRCode();
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('situation');
            window.loadFamilyData();
            getUserLocation();
        });
    </script>
</body>
</html>